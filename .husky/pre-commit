#!/usr/bin/env sh

# ============================================
# PRE-COMMIT HOOK — 3-step Biome contract
# ============================================
# Step 1: format --write staged files only (batched, safe)
# Step 2: biome lint src (directory-based, CI parity)
# Step 3: biome format src (directory-based, CI parity)

echo "Running mandatory pre-commit checks..."
echo ""

# Get the list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# ============================================
# 1. Biome lint + format
# ============================================
JS_FILES=$(echo "$STAGED_FILES" | grep -E '\.(js|jsx|ts|tsx|json)$' || true)

if [ -n "$JS_FILES" ]; then
  echo "[1/3] Running Biome lint + format..."

  # Step 1 (staged-only): Auto-fix formatting and re-stage
  # Batched with xargs -n 50 to avoid Windows 32K argv limit
  echo "$JS_FILES" | xargs -n 50 npx biome format --write --vcs-enabled=false 2>/dev/null || true
  echo "$JS_FILES" | xargs -n 50 git add 2>/dev/null || true

  # Step 2 (directory-based): Strict lint — exact CI command
  # 0 errors, 0 warnings required
  npx biome lint src
  BIOME_EXIT=$?

  if [ $BIOME_EXIT -ne 0 ]; then
    echo ""
    echo "Biome lint failed! (errors or warnings found)"
    echo "Fix the issues above or run: npm run lint:fix"
    echo ""
    echo "To run the same check as CI: npm run lint:ci"
    exit 1
  fi

  # Step 3 (directory-based): Format check — no --write
  npx biome format src 2>/dev/null
  FORMAT_EXIT=$?

  if [ $FORMAT_EXIT -ne 0 ]; then
    echo ""
    echo "Biome format check failed! Run: npm run format"
    exit 1
  fi

  echo "Biome passed (lint + format)"
else
  echo "[1/3] No JS/TS files staged, skipping Biome"
fi

# ============================================
# 2. TypeScript type checking
# ============================================
TS_FILES=$(echo "$STAGED_FILES" | grep -E '\.(ts|tsx)$' | grep '^src/' || true)

if [ -n "$TS_FILES" ]; then
  echo "[2/3] Running TypeScript type check..."

  npm run typecheck

  if [ $? -ne 0 ]; then
    echo ""
    echo "TypeScript type check failed!"
    echo "Fix the type errors above before committing."
    exit 1
  fi
  echo "TypeScript check passed"
else
  echo "[2/3] No TypeScript files staged, skipping type check"
fi

# ============================================
# 3. Case consistency check (camelCase API access)
# ============================================
FE_FILES=$(echo "$STAGED_FILES" | grep -E '^src/.+\.(js|jsx|ts|tsx)$' || true)

if [ -n "$FE_FILES" ]; then
  echo "[3/3] Running case consistency check..."

  CASE_TMP="$(mktemp -t snakecase.XXXXXX 2>/dev/null || mktemp)"

  set +e
  node scripts/check-snake-case-access.js --show-baseline >"$CASE_TMP" 2>&1
  CASE_EXIT=$?
  set -e

  if [ $CASE_EXIT -ne 0 ]; then
    # Print only the "NEW violations" section if present; otherwise full output
    if grep -q "^NEW violations" "$CASE_TMP"; then
      awk 'BEGIN{p=0} /^NEW violations/{p=1} p{print}' "$CASE_TMP"
    else
      cat "$CASE_TMP"
    fi

    rm -f "$CASE_TMP"
    echo ""
    echo "Case consistency check failed!"
    echo ""
    echo "  DECISION RULE: Ask yourself — where does this data come from?"
    echo ""
    echo "  Option 1 — Data comes from our API (invoiceService, axiosApi, etc.)"
    echo "     The API already returns camelCase. Just use camelCase:"
    echo "       item.invoice_number  ->  item.invoiceNumber"
    echo "       customer.credit_limit  ->  customer.creditLimit"
    echo ""
    echo "  Option 2 — This line IS a mapper that transforms raw snake_case"
    echo "     Add '// snake-ok' at end of that specific line only:"
    echo "       const x = row.credit_limit; // snake-ok"
    echo ""
    echo "  Option 3 — Permanently approve via baseline (use sparingly)"
    echo "     node scripts/check-snake-case-access.js --update-baseline"
    exit 1
  fi

  rm -f "$CASE_TMP"
  echo "Case consistency check passed"
else
  echo "[3/3] No frontend source files staged, skipping case consistency check"
fi

# ============================================
# All checks passed
# ============================================
echo ""
echo "All pre-commit checks passed!"
