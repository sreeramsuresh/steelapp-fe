#!/usr/bin/env sh

# ============================================
# ANTI-BYPASS PRE-COMMIT HOOK
# This hook CANNOT be skipped with --no-verify
# ============================================
# If you attempted to use --no-verify, this is why it didn't work:
# Husky hooks cannot be bypassed - they're enforced at the git level

echo "üîç Running mandatory pre-commit checks..."
echo "‚ö†Ô∏è  Note: These checks CANNOT be skipped with --no-verify"
echo ""

# Get the list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# ============================================
# 1. Biome lint and format on staged files
# ============================================
JS_FILES=$(echo "$STAGED_FILES" | grep -E '\.(js|jsx|ts|tsx|json)$' || true)

if [ -n "$JS_FILES" ]; then
  echo "[1/2] Running Biome on staged files..."

  # Run Biome check on staged files with VCS disabled for new files
  npx biome check $JS_FILES --write --vcs-enabled=false 2>&1 | grep -v "This path was provided but ignored"

  BIOME_EXIT=$?
  if [ $BIOME_EXIT -ne 0 ]; then
    echo ""
    echo "Biome check failed! (errors or warnings found)"
    echo "Fix the issues above or run: npm run lint:fix"
    echo ""
    echo "To run the same check as CI: npm run lint:ci"
    exit 1
  fi
  echo "Biome passed"
else
  echo "[1/2] No files staged, skipping Biome"
fi

# ============================================
# 2. TypeScript type checking
# ============================================
TS_FILES=$(echo "$STAGED_FILES" | grep -E '\.(ts|tsx)$' | grep '^src/' || true)

if [ -n "$TS_FILES" ]; then
  echo "[2/2] Running TypeScript type check..."

  npm run typecheck

  if [ $? -ne 0 ]; then
    echo ""
    echo "TypeScript type check failed!"
    echo "Fix the type errors above before committing."
    exit 1
  fi
  echo "TypeScript check passed"
else
  echo "[2/2] No TypeScript files staged, skipping type check"
fi

# ============================================
# 3. Case consistency check (camelCase API access)
# ============================================
COMPONENT_FILES=$(echo "$STAGED_FILES" | grep -E '^src/(components|pages)/.+\.(js|jsx|ts|tsx)$' || true)

if [ -n "$COMPONENT_FILES" ]; then
  echo "[3/3] Running case consistency check..."

  CASE_TMP="$(mktemp -t snakecase.XXXXXX 2>/dev/null || mktemp)"

  set +e
  node scripts/check-snake-case-access.js --show-baseline >"$CASE_TMP" 2>&1
  CASE_EXIT=$?
  set -e

  if [ $CASE_EXIT -ne 0 ]; then
    # Print only the "NEW violations" section if present; otherwise full output
    if grep -q "^NEW violations" "$CASE_TMP"; then
      awk 'BEGIN{p=0} /^NEW violations/{p=1} p{print}' "$CASE_TMP"
    else
      cat "$CASE_TMP"
    fi

    rm -f "$CASE_TMP"
    echo ""
    echo "Case consistency check failed!"
    echo ""
    echo "  DECISION RULE: Ask yourself ‚Äî where does this data come from?"
    echo ""
    echo "  ‚úÖ Option 1 ‚Äî Data comes from our API (invoiceService, axiosApi, etc.)"
    echo "     The API already returns camelCase. Just use camelCase:"
    echo "       item.invoice_number  ‚Üí  item.invoiceNumber"
    echo "       customer.credit_limit  ‚Üí  customer.creditLimit"
    echo "     WRONG CHOICE if: the field genuinely doesn't exist in camelCase yet"
    echo "     (will silently return undefined at runtime ‚Äî check Network tab first)"
    echo ""
    echo "  ‚ö†Ô∏è  Option 2 ‚Äî This line IS a mapper that transforms raw snake_case"
    echo "     e.g. inside a normalizeCustomer() or a raw SQL result handler."
    echo "     Add '// snake-ok' at end of that specific line only:"
    echo "       const x = row.credit_limit; // snake-ok"
    echo "     WRONG CHOICE if: this is a normal component reading API response"
    echo "     (hides a real bug ‚Äî component gets undefined in production)"
    echo ""
    echo "  üîí Option 3 ‚Äî Permanently approve via baseline (use sparingly)"
    echo "     node scripts/check-snake-case-access.js --update-baseline"
    echo "     ONLY valid when: field comes from a raw DB/proto/webhook payload"
    echo "     that is NOT yet camelCase-normalised anywhere in the pipeline."
    echo "     WRONG CHOICE if: you just want to silence the warning quickly"
    echo "     (approves the violation forever, defeating the purpose of this check)"
    exit 1
  fi

  rm -f "$CASE_TMP"
  echo "Case consistency check passed"
else
  echo "[3/3] No component/page files staged, skipping case consistency check"
fi

# ============================================
# All checks passed
# ============================================
echo ""
echo "All pre-commit checks passed!"
