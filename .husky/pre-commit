#!/usr/bin/env sh

# ============================================
# ANTI-BYPASS PRE-COMMIT HOOK
# This hook CANNOT be skipped with --no-verify
# ============================================
# If you attempted to use --no-verify, this is why it didn't work:
# Husky hooks cannot be bypassed - they're enforced at the git level

echo "ðŸ” Running mandatory pre-commit checks..."
echo "âš ï¸  Note: These checks CANNOT be skipped with --no-verify"
echo ""

# Get the list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# ============================================
# 1. Biome lint and format on staged files
# ============================================
JS_FILES=$(echo "$STAGED_FILES" | grep -E '\.(js|jsx|ts|tsx|json)$' || true)

if [ -n "$JS_FILES" ]; then
  echo "[1/2] Running Biome on staged files..."

  # Run Biome check on staged files with VCS disabled for new files
  npx biome check $JS_FILES --write --vcs-enabled=false 2>&1 | grep -v "This path was provided but ignored"

  # Only fail on actual errors, not on ignored file warnings
  BIOME_EXIT=$?
  if [ $BIOME_EXIT -ne 0 ] && [ $BIOME_EXIT -ne 1 ]; then
    echo ""
    echo "Biome check failed!"
    echo "Fix the issues above or run: npm run lint:fix"
    echo ""
    echo "To run the same check as CI: npm run lint:ci"
    exit 1
  fi
  echo "Biome passed"
else
  echo "[1/2] No files staged, skipping Biome"
fi

# ============================================
# 2. TypeScript type checking
# ============================================
TS_FILES=$(echo "$STAGED_FILES" | grep -E '\.(ts|tsx)$' | grep '^src/' || true)

if [ -n "$TS_FILES" ]; then
  echo "[2/2] Running TypeScript type check..."

  npm run typecheck

  if [ $? -ne 0 ]; then
    echo ""
    echo "TypeScript type check failed!"
    echo "Fix the type errors above before committing."
    exit 1
  fi
  echo "TypeScript check passed"
else
  echo "[2/2] No TypeScript files staged, skipping type check"
fi

# ============================================
# 3. Case consistency check (camelCase API access)
# ============================================
COMPONENT_FILES=$(echo "$STAGED_FILES" | grep -E '^src/(components|pages)/.+\.(js|jsx|ts|tsx)$' || true)

if [ -n "$COMPONENT_FILES" ]; then
  echo "[3/3] Running case consistency check..."

  node scripts/check-snake-case-access.js

  if [ $? -ne 0 ]; then
    echo ""
    echo "Case consistency check failed!"
    echo "Fix snake_case accesses above, or add '// snake-ok' comment to suppress."
    echo "To update the baseline for intentional additions: node scripts/check-snake-case-access.js --update-baseline"
    exit 1
  fi
  echo "Case consistency check passed"
else
  echo "[3/3] No component/page files staged, skipping case consistency check"
fi

# ============================================
# All checks passed
# ============================================
echo ""
echo "All pre-commit checks passed!"
